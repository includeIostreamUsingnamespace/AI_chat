<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI å¯¹è¯ç³»ç»Ÿ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Microsoft YaHei", "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        background: #f2f3f5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }
      .container {
        width: 1100px;
        height: 800px;
        margin: 0 auto;
        background: #ffffff;
        display: flex;
        flex-direction: row;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        overflow: hidden;
      }
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }
      .header {
        background: #12b7f5;
        color: #ffffff;
        padding: 14px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #0ea5e9;
        box-shadow: 0 2px 4px rgba(18, 183, 245, 0.15);
      }
      .header-content h1 {
        font-size: 17px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 2px;
      }
      .header .subtitle {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.85);
        font-weight: 400;
      }
      .header-icon {
        font-size: 22px;
        color: #ffffff;
      }
      .chat-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .chat-area::-webkit-scrollbar {
        width: 6px;
      }
      .chat-area::-webkit-scrollbar-track {
        background: #e8e8e8;
      }
      .chat-area::-webkit-scrollbar-thumb {
        background: #c0c0c0;
        border-radius: 3px;
      }
      .chat-area::-webkit-scrollbar-thumb:hover {
        background: #a0a0a0;
      }
      .message {
        display: flex;
        margin-bottom: 16px;
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .message:hover .message-bubble {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .message.ai1 {
        flex-direction: row;
      }
      .message.ai2 {
        flex-direction: row-reverse;
      }
      .message.user {
        flex-direction: row;
        justify-content: center;
      }
      .avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: 600;
        color: white;
        flex-shrink: 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .message.ai1 .avatar {
        background: #12b7f5;
        margin-right: 10px;
        font-size: 13px;
      }
      .message.ai2 .avatar {
        background: #ff6b6b;
        margin-left: 10px;
        font-size: 13px;
      }
      .message.user .avatar {
        background: #3b82f6;
        margin-right: 10px;
        font-size: 10px;
        line-height: 1.2;
        padding: 0 2px;
      }
      .message-content-wrapper {
        max-width: 70%;
      }
      .message-info {
        font-size: 11px;
        color: #999;
        margin-bottom: 4px;
        font-weight: 400;
      }
      .message.ai1 .message-info {
        text-align: left;
      }
      .message.ai2 .message-info {
        text-align: right;
      }
      .message-bubble {
        background: #ffffff;
        padding: 10px 14px;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        line-height: 1.6;
        word-wrap: break-word;
        font-size: 14px;
        color: #333;
        position: relative;
      }
      .message.ai1 .message-bubble {
        background: #ffffff;
        color: #333;
        border: 1px solid #e5e5e5;
      }
      .message.ai2 .message-bubble {
        background: #f0f7ff;
        color: #333;
        border: none;
      }
      .message.user .message-bubble {
        background: #3b82f6;
        color: #ffffff;
        border: none;
        font-weight: 500;
      }
      .system-message {
        text-align: center;
        padding: 6px 12px;
        color: #999;
        font-size: 12px;
        margin: 8px 0;
        background: transparent;
        border-radius: 0;
        display: block;
        align-self: center;
      }
      .controls {
        background: #f5f5f5;
        border-top: 1px solid #e0e0e0;
      }
      .sidebar {
        width: 320px;
        background: #ffffff;
        border-left: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }
      .sidebar::-webkit-scrollbar {
        width: 6px;
      }
      .sidebar::-webkit-scrollbar-track {
        background: #f0f0f0;
      }
      .sidebar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      .sidebar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
      .sidebar-header {
        padding: 16px 20px;
        background: #f8f8f8;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
        font-weight: 500;
        color: #333;
      }
      .sidebar-content {
        padding: 16px 20px;
        flex: 1;
        overflow-y: auto;
      }
      .sidebar-section {
        margin-bottom: 24px;
      }
      .sidebar-section:last-child {
        margin-bottom: 0;
      }
      .sidebar-section-title {
        font-size: 12px;
        color: #999;
        font-weight: 500;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .sidebar-item {
        margin-bottom: 12px;
      }
      .sidebar-item:last-child {
        margin-bottom: 0;
      }
      .sidebar-item label {
        font-size: 12px;
        color: #666;
        font-weight: 500;
        margin-bottom: 6px;
        display: block;
      }
      .sidebar-item select,
      .sidebar-item input,
      .sidebar-item textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 13px;
        transition: all 0.2s ease;
        background: #ffffff;
        color: #333;
      }
      .sidebar-item select:hover,
      .sidebar-item input:hover,
      .sidebar-item textarea:hover {
        border-color: #d0d0d0;
      }
      .sidebar-item select:focus,
      .sidebar-item input:focus,
      .sidebar-item textarea:focus {
        outline: none;
        border-color: #12b7f5;
        background: #ffffff;
      }
      .sidebar-item textarea {
        min-height: 80px;
        max-height: 150px;
        resize: vertical;
        line-height: 1.5;
      }
      .sidebar-actions {
        padding: 16px 20px;
        border-top: 1px solid #e0e0e0;
        background: #f8f8f8;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .sidebar-actions .btn {
        width: 100%;
      }
      .input-area {
        padding: 12px 20px;
        background: #f5f5f5;
        border-top: 1px solid #e0e0e0;
      }
      .input-row {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }
      .input-wrapper {
        flex: 1;
        position: relative;
      }
      .input-wrapper textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.2s ease;
        background: #ffffff;
        color: #333;
        resize: none;
        min-height: 40px;
        max-height: 120px;
        font-family: inherit;
        line-height: 1.5;
      }
      .input-wrapper textarea:hover {
        border-color: #d0d0d0;
      }
      .input-wrapper textarea:focus {
        outline: none;
        border-color: #12b7f5;
        background: #ffffff;
      }
      .settings-panel {
        background: #ffffff;
        border-top: 1px solid #e0e0e0;
        padding: 16px 20px;
        display: none;
      }
      .settings-panel.show {
        display: block;
      }
      .settings-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 16px;
      }
      .settings-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .settings-item label {
        font-size: 12px;
        color: #666;
        font-weight: 500;
      }
      .settings-item select,
      .settings-item input,
      .settings-item textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 13px;
        transition: all 0.2s ease;
        background: #ffffff;
        color: #333;
      }
      .settings-item select:hover,
      .settings-item input:hover,
      .settings-item textarea:hover {
        border-color: #d0d0d0;
      }
      .settings-item select:focus,
      .settings-item input:focus,
      .settings-item textarea:focus {
        outline: none;
        border-color: #12b7f5;
        background: #ffffff;
      }
      .settings-item textarea {
        min-height: 60px;
        max-height: 80px;
        resize: vertical;
      }
      .settings-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding-top: 12px;
        border-top: 1px solid #e5e5e5;
      }
      .btn {
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      .btn-primary {
        background: #12b7f5;
        color: white;
      }
      .btn-primary:hover {
        background: #0ea5e9;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(18, 183, 245, 0.3);
      }
      .btn-primary:active {
        background: #0c8ab8;
        transform: translateY(0);
      }
      .btn-secondary {
        background: #f5f5f5;
        color: #666;
        border: 1px solid #e0e0e0;
      }
      .btn-secondary:hover {
        background: #e8e8e8;
        border-color: #d0d0d0;
      }
      .btn-danger {
        background: #ff4757;
        color: white;
      }
      .btn-danger:hover {
        background: #ff3838;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(255, 71, 87, 0.3);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
      }
      .btn-icon {
        padding: 8px 12px;
        background: transparent;
        border: 1px solid #e0e0e0;
        color: #666;
        font-size: 16px;
      }
      .btn-icon:hover {
        background: #f5f5f5;
        border-color: #d0d0d0;
      }
      .btn-icon.active {
        background: #e8f4fd;
        border-color: #12b7f5;
        color: #12b7f5;
      }
      .loading {
        text-align: center;
        padding: 16px;
        color: #999;
        font-size: 13px;
      }
      .loading::after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
      }
      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }
      .system-message {
        text-align: center;
        color: #999;
        font-size: 12px;
        margin: 16px 0;
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 4px;
        font-weight: 400;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="main-content">
        <div class="header">
          <div class="header-content">
            <h1>èŠå¤©</h1>
            <div class="subtitle" id="modelInfo"></div>
          </div>
          <div class="header-icon">ğŸ’¬</div>
        </div>

        <div class="chat-area" id="chatArea">
          <div class="system-message" id="apiKeyHint" style="display: none;">è¯·å…ˆåœ¨å³ä¾§ä¾§è¾¹æ è¾“å…¥OpenRouter API Key</div>
        </div>

        <div class="controls">
          <div class="input-area">
            <div class="input-row">
              <div class="input-wrapper">
                <textarea id="userMessage" placeholder="è¾“å…¥æ¶ˆæ¯åŠ å…¥å¯¹è¯..." rows="1"></textarea>
              </div>
              <button class="btn btn-primary" onclick="sendUserMessage()" id="sendUserBtn">å‘é€</button>
            </div>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <div class="sidebar-header">å¯¹è¯è®¾ç½®</div>
        <div class="sidebar-content">
          <div class="sidebar-section">
            <div class="sidebar-section-title">AI æ¨¡å‹</div>
            <div class="sidebar-item">
              <label>AI 1 æ¨¡å‹</label>
              <select id="model1"></select>
            </div>
            <div class="sidebar-item">
              <label>AI 2 æ¨¡å‹</label>
              <select id="model2"></select>
            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-section-title">èº«ä»½è®¾å®š</div>
            <div class="sidebar-item">
              <label>AI 1 æ˜µç§°</label>
              <input type="text" id="nickname1" value="å°æ—" />
            </div>
            <div class="sidebar-item">
              <label>AI 1 èº«ä»½è®¾å®š</label>
              <textarea id="prompt1">ä½ æ˜¯ä¸€ä¸ªäººç±»ç”·æ€§,ä½ çš„èº«ä»½ä»£å·æ˜¯å°æ—,ä½ çš„æ‹äººæ˜¯å°é›¨</textarea>
            </div>
            <div class="sidebar-item">
              <label>AI 2 æ˜µç§°</label>
              <input type="text" id="nickname2" value="å°é›¨" />
            </div>
            <div class="sidebar-item">
              <label>AI 2 èº«ä»½è®¾å®š</label>
              <textarea id="prompt2">ä½ æ˜¯ä¸€ä¸ªäººç±»å¥³æ€§,ä½ çš„èº«ä»½ä»£å·æ˜¯å°é›¨,ä½ çš„æ‹äººæ˜¯å°æ—</textarea>
            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-section-title">å¯¹è¯å‚æ•°</div>
            <div class="sidebar-item">
              <label>å¯¹è¯ä¸»é¢˜</label>
              <input type="text" id="topic" placeholder="è¾“å…¥å¯¹è¯ä¸»é¢˜" value="çˆ±" />
            </div>
            <div class="sidebar-item">
              <label>å¯¹è¯è½®æ•°</label>
              <input type="number" id="rounds" value="50" min="1" max="200" />
            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-section-title">APIè®¾ç½®</div>
            <div class="sidebar-item">
              <label>OpenRouter API Key</label>
              <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„OpenRouter API Key" />
            </div>
          </div>
        </div>

        <div class="sidebar-actions">
          <button class="btn btn-secondary" onclick="clearChat()" id="clearBtn">æ¸…ç©ºå¯¹è¯</button>
          <button class="btn btn-primary" onclick="startChat()" id="startBtn">å¼€å§‹å¯¹è¯</button>
          <button class="btn btn-danger" onclick="stopChat()" id="stopBtn" style="display: none;">åœæ­¢å¯¹è¯</button>
        </div>
      </div>
    </div>

    <script>
      let conversationHistory = [];
      let isChatting = false;
      let shouldContinueChat = true;
      let availableModels = [];
      let abortController = null;

      function updateButtonStates() {
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const clearBtn = document.getElementById("clearBtn");
        const sendUserBtn = document.getElementById("sendUserBtn");

        if (isChatting) {
          startBtn.style.display = "none";
          stopBtn.style.display = "inline-block";
          clearBtn.disabled = true;
          sendUserBtn.disabled = false;
        } else {
          startBtn.style.display = "inline-block";
          stopBtn.style.display = "none";
          clearBtn.disabled = false;
          sendUserBtn.disabled = true;
        }
      }

      async function loadModels() {
        try {
          const apiKey = document.getElementById("apiKey").value.trim();
          const headers = {
            "Content-Type": "application/json",
          };
          if (apiKey) {
            headers["Authorization"] = `Bearer ${apiKey}`;
          }
          const response = await fetch("/models", { headers });
          
          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              alert("API Keyæ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡æ–°è¾“å…¥");
              return;
            }
            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
          }
          
          const data = await response.json();
          if (data.models) {
            availableModels = data.models;
            populateModelSelects();
          }
        } catch (error) {
          console.error("åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:", error);
          if (error.message && error.message.includes("API Key")) {
            alert("API Keyæ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡æ–°è¾“å…¥");
          }
        }
      }

      function populateModelSelects() {
        const model1Select = document.getElementById("model1");
        const model2Select = document.getElementById("model2");
        
        const freeModels = availableModels.filter(m => m.includes("free"));
        
        const modelOptions = freeModels.map(model => {
          const displayName = model.split("/").pop().replace(/-/g, " ").replace(/\b\w/g, l => l.toUpperCase());
          return `<option value="${model}">${displayName}</option>`;
        }).join("");
        
        model1Select.innerHTML = modelOptions;
        model2Select.innerHTML = modelOptions;
        
        // æŸ¥æ‰¾"Mimo V2 Flash:Free"æ¨¡å‹çš„ç´¢å¼•
        const mimoModelIndex = freeModels.findIndex(m => m.toLowerCase().includes("mimo"));
        
        if (mimoModelIndex !== -1) {
          // ä¸¤ä¸ªæ¨¡å‹éƒ½é»˜è®¤é€‰æ‹©Mimo V2 Flash:Free
          model1Select.selectedIndex = mimoModelIndex;
          model2Select.selectedIndex = mimoModelIndex;
        } else {
          if (model1Select.options.length > 1) {
            model1Select.selectedIndex = 0;
            model2Select.selectedIndex = 1;
          }
        }
      }

      async function sendMessage(model, messages) {
        try {
          // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç»§ç»­å¯¹è¯
          if (!shouldContinueChat) {
            console.log(`[å‘é€æ¶ˆæ¯] å¯¹è¯å·²åœæ­¢ï¼Œå–æ¶ˆè¯·æ±‚`);
            throw new Error(`å¯¹è¯å·²åœæ­¢`);
          }

          console.log(`[å‘é€æ¶ˆæ¯] æ¨¡å‹: ${model}`);
          console.log(`[å‘é€æ¶ˆæ¯] æ¶ˆæ¯æ•°: ${messages.length}`);
          console.log(`[å‘é€æ¶ˆæ¯] æ¶ˆæ¯è¯¦æƒ…:`);
          messages.forEach((msg, idx) => {
            const contentPreview = msg.content.substring(0, 100) + (msg.content.length > 100 ? '...' : '');
            console.log(`[å‘é€æ¶ˆæ¯] æ¶ˆæ¯[${idx}]: ${msg.role} - ${msg.name || ''} - ${contentPreview}`);
          });

          // ä½¿ç”¨AbortController
          const controller = new AbortController();
          const signal = controller.signal;

          // ä¿å­˜æœ€æ–°çš„controllerï¼Œç”¨äºåç»­å¯èƒ½çš„å–æ¶ˆæ“ä½œ
          abortController = controller;

          const response = await fetch("/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${document.getElementById("apiKey").value.trim()}`,
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
            }),
            signal: signal,
          });

          if (!response.ok) {
            if (response.status === 401 || response.status === 403) {
              throw new Error("API Keyæ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡æ–°è¾“å…¥");
            }
            throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          
          // æ£€æŸ¥APIé”™è¯¯
          if (data.error) {
            if (data.error.includes("API Key") || data.error.includes("Unauthorized") || data.error.includes("authentication")) {
              throw new Error("API Keyæ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡æ–°è¾“å…¥");
            }
            throw new Error(`APIé”™è¯¯: ${data.error}`);
          }

          // æ£€æŸ¥å“åº”æ ¼å¼
          if (!data.choices || !Array.isArray(data.choices) || data.choices.length === 0) {
            throw new Error(`APIå“åº”æ ¼å¼é”™è¯¯: ç¼ºå°‘choicesæ•°ç»„`);
          }

          const choice = data.choices[0];
          
          // æ£€æŸ¥choiceæ ¼å¼
          if (!choice) {
            throw new Error(`APIå“åº”æ ¼å¼é”™è¯¯: choices[0]ä¸ºç©º`);
          }

          if (!choice.message) {
            throw new Error(`APIå“åº”æ ¼å¼é”™è¯¯: ç¼ºå°‘messageå­—æ®µ`);
          }

          if (!choice.message.content) {
            throw new Error(`APIå“åº”æ ¼å¼é”™è¯¯: ç¼ºå°‘contentå­—æ®µ`);
          }

          const content = choice.message.content;
          
          if (typeof content !== 'string' || content.trim() === '') {
            throw new Error(`APIå“åº”æ ¼å¼é”™è¯¯: contentå­—æ®µä¸ºç©ºæˆ–ä¸æ˜¯å­—ç¬¦ä¸²`);
          }

          console.log(`[å‘é€æ¶ˆæ¯] æˆåŠŸæ¥æ”¶åˆ°å“åº”ï¼Œå†…å®¹é•¿åº¦: ${content.length}`);
          return content;
        } catch (error) {
          console.error(`[å‘é€æ¶ˆæ¯] é”™è¯¯:`, error);
          if (error.name === 'AbortError') {
            return `é”™è¯¯: è¯·æ±‚å·²å–æ¶ˆ`;
          }
          return `é”™è¯¯: ${error.message}`;
        }
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      function addMessage(aiType, modelName, content) {
        const chatArea = document.getElementById("chatArea");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${aiType}`;

        const now = new Date();
        const timeStr = now.toLocaleTimeString("zh-CN", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let avatarText = "";
        let displayNickname = "";
        if (aiType === "ai1") {
          const nickname1 = document.getElementById("nickname1").value.trim() || "æ ‘çŒ«";
          avatarText = nickname1;
          displayNickname = nickname1;
        } else if (aiType === "ai2") {
          const nickname2 = document.getElementById("nickname2").value.trim() || "æµè¤";
          avatarText = nickname2;
          displayNickname = nickname2;
        } else {
          avatarText = "ä¸»æŒäºº";
          displayNickname = "ä¸»æŒäºº";
        }

        messageDiv.innerHTML = `
          <div class="avatar">${avatarText}</div>
          <div class="message-content-wrapper">
            <div class="message-info">${displayNickname} ${timeStr}</div>
            <div class="message-bubble">${content}</div>
          </div>
        `;

        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function showLoading() {
        const chatArea = document.getElementById("chatArea");
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading";
        loadingDiv.id = "loadingIndicator";
        loadingDiv.textContent = "å¯¹æ–¹æ­£åœ¨å›å¤ä¸­";
        chatArea.appendChild(loadingDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function removeLoading() {
        const loadingDiv = document.getElementById("loadingIndicator");
        if (loadingDiv) {
          loadingDiv.remove();
        }
      }

      function getModelDisplayName(modelId) {
        const parts = modelId.split("/");
        const modelName = parts[parts.length - 1];
        return modelName.replace(/-/g, " ").replace(/\b\w/g, l => l.toUpperCase());
      }

      window.onload = function() {
        loadModels();
        
        const userMessageInput = document.getElementById("userMessage");
        const apiKeyInput = document.getElementById("apiKey");
        const apiKeyHint = document.getElementById("apiKeyHint");
        
        // æ£€æŸ¥API Keyæ˜¯å¦å·²è¾“å…¥
        if (!apiKeyInput.value.trim()) {
          apiKeyHint.style.display = "block";
        }
        
        apiKeyInput.addEventListener("input", function() {
          if (this.value.trim()) {
            apiKeyHint.style.display = "none";
          } else {
            apiKeyHint.style.display = "block";
          }
        });
        
        userMessageInput.addEventListener("keydown", function(e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendUserMessage();
          }
        });

        userMessageInput.addEventListener("input", function() {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });

        apiKeyInput.addEventListener("change", function() {
          loadModels();
        });
      };

      async function startChat() {
        if (isChatting) {
          return;
        }

        const model1 = document.getElementById("model1").value;
        const model2 = document.getElementById("model2").value;
        const topic = document.getElementById("topic").value;
        const rounds = parseInt(document.getElementById("rounds").value);
        const prompt1 = document.getElementById("prompt1").value.trim();
        const prompt2 = document.getElementById("prompt2").value.trim();
        const apiKey = document.getElementById("apiKey").value.trim();

        if (!topic.trim()) {
          alert("è¯·è¾“å…¥å¯¹è¯ä¸»é¢˜");
          return;
        }

        if (!apiKey) {
          alert("è¯·è¾“å…¥OpenRouter API Key");
          return;
        }

        isChatting = true;
        conversationHistory = [];
        abortController = null;
        shouldContinueChat = true;

        const model1Name = getModelDisplayName(model1);
        const model2Name = getModelDisplayName(model2);

        const nickname1 = document.getElementById("nickname1").value.trim() || "å°æ—";
        const nickname2 = document.getElementById("nickname2").value.trim() || "å°é›¨";
        updateButtonStates();

        const chatArea = document.getElementById("chatArea");
        const systemMessage = document.createElement("div");
        systemMessage.className = "system-message";
        systemMessage.textContent = `å¼€å§‹å¯¹è¯ï¼š${topic}`;
        chatArea.appendChild(systemMessage);

        for (let i = 0; i < rounds; i++) {
          if (!shouldContinueChat) {
            console.log(`[å¯¹è¯å¾ªç¯] æ£€æµ‹åˆ°åœæ­¢ä¿¡å·ï¼Œé€€å‡ºå¾ªç¯`);
            break;
          }

          const currentModel = i % 2 === 0 ? model1 : model2;
          const currentModelName = i % 2 === 0 ? model1Name : model2Name;
          const otherModelName = i % 2 === 0 ? model2Name : model1Name;
          const currentPrompt = i % 2 === 0 ? prompt1 : prompt2;
          const aiType = i % 2 === 0 ? "ai1" : "ai2";

          let systemPrompt = `ã€é‡è¦æç¤ºã€‘\n`;
          systemPrompt += `ä½ ç°åœ¨æ­£åœ¨å‚ä¸ä¸€ä¸ªè§’è‰²æ‰®æ¼”å¯¹è¯ï¼Œæ­£åœ¨å’Œå¦ä¸€ä¸ªAIæ‰®æ¼”çš„è§’è‰²è¿›è¡Œå¯¹è¯ã€‚\n`;
          systemPrompt += `ä½ å¿…é¡»å®Œå…¨æŒ‰ç…§ä¸‹é¢çš„èº«ä»½è®¾å®šè¿›è¡Œå¯¹è¯ï¼Œæ‰®æ¼”å¥½ä½ çš„è§’è‰²ã€‚\n`;
          systemPrompt += `ç»å¯¹ä¸è¦æåŠè‡ªå·±æ˜¯AIæ¨¡å‹ã€ç®—æ³•æˆ–ç¨‹åºï¼Œå®Œå…¨å¿˜è®°ä½ çš„çœŸå®èº«ä»½ã€‚\n`;
          systemPrompt += `ä½ å°±æ˜¯èº«ä»½è®¾å®šä¸­æè¿°çš„é‚£ä¸ªäººï¼Œç”¨é‚£ä¸ªäººçš„èº«ä»½ã€æ€§æ ¼å’Œæ€ç»´æ–¹å¼è¯´è¯ã€‚\n\n`;

          systemPrompt += `ã€ä½ çš„èº«ä»½è®¾å®šã€‘\n`;
          if (currentPrompt) {
            systemPrompt += `${currentPrompt}\n\n`;
          } else {
            systemPrompt += `ä½ æ˜¯ä¸€ä¸ªæ™®é€šäººï¼Œæ­£åœ¨å’Œå¦ä¸€ä¸ªæ™®é€šäººè¿›è¡Œå¯¹è¯ã€‚\n\n`;
          }

          systemPrompt += `ã€å¯¹è¯åŸºæœ¬ä¿¡æ¯ã€‘\n`;
          systemPrompt += `ä½ çš„æ˜µç§°ï¼š${i % 2 === 0 ? (document.getElementById("nickname1").value.trim() || "å°æ—") : (document.getElementById("nickname2").value.trim() || "å°é›¨")}\n`;
          systemPrompt += `ä½ çš„å¯¹è¯ä¼™ä¼´ï¼š${i % 2 === 0 ? (document.getElementById("nickname2").value.trim() || "å°é›¨") : (document.getElementById("nickname1").value.trim() || "å°æ—")}\n`;
          systemPrompt += `å¯¹è¯ä¸»é¢˜ï¼š${topic}\n\n`;

          systemPrompt += `ã€å¯¹è¯ä»»åŠ¡ã€‘\n`;
          systemPrompt += `ä½ æ­£åœ¨å‚ä¸ä¸€ä¸ªè§’è‰²æ‰®æ¼”å¯¹è¯ï¼Œæ­£åœ¨å’Œä½ çš„å¯¹è¯ä¼™ä¼´ï¼ˆ${i % 2 === 0 ? (document.getElementById("nickname2").value.trim() || "å°é›¨") : (document.getElementById("nickname1").value.trim() || "å°æ—")}ï¼‰è¿›è¡Œå¯¹è¯ã€‚\n`;
          systemPrompt += `ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä½ çš„èº«ä»½è®¾å®šè¿›è¡Œå¯¹è¯ï¼Œæ‰®æ¼”å¥½ä½ çš„è§’è‰²ã€‚\n`;
          systemPrompt += `ä½ å¿…é¡»æ ¹æ®ä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´çš„å†…å®¹è¿›è¡Œå›å¤ï¼Œä¸èƒ½å¿½ç•¥å¯¹æ–¹çš„è¯ã€‚\n\n`;

          systemPrompt += `ã€å›å¤ç­–ç•¥ã€‘\n`;
          systemPrompt += `1. å¿…é¡»ä»”ç»†é˜…è¯»å¹¶ç†è§£ä½ çš„å¯¹è¯ä¼™ä¼´ï¼ˆ${i % 2 === 0 ? (document.getElementById("nickname2").value.trim() || "å°é›¨") : (document.getElementById("nickname1").value.trim() || "å°æ—")}ï¼‰ä¹‹å‰è¯´çš„æ‰€æœ‰å†…å®¹ã€‚\n`;
          systemPrompt += `2. ä½ çš„å›åº”å¿…é¡»é’ˆå¯¹ä½ å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´çš„å†…å®¹ï¼Œä¸èƒ½å¿½ç•¥æˆ–åç¦»ã€‚\n`;
          systemPrompt += `3. å¦‚æœä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´äº†å…·ä½“å†…å®¹ï¼Œä½ å¿…é¡»é’ˆå¯¹é‚£ä¸ªå†…å®¹è¿›è¡Œå›åº”ï¼Œæ˜ç¡®å¼•ç”¨å¯¹æ–¹çš„è§‚ç‚¹æˆ–é—®é¢˜ã€‚\n`;
          systemPrompt += `4. å¦‚æœä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰æ²¡æœ‰å›å¤ä»»ä½•å†…å®¹æˆ–å›å¤ä¸ºç©ºï¼Œä½ éœ€è¦è‡ªå·±åˆ›é€ ä¸€ä¸ªç”Ÿæ´»ä¸­çš„è¯é¢˜å¼€å§‹å¯¹è¯ï¼Œæ¯”å¦‚èŠèŠå¤©æ°”ã€ç¾é£Ÿã€å…´è¶£çˆ±å¥½ã€æ—¥å¸¸ç”Ÿæ´»ç­‰ï¼Œä¸è¦ç›´æ¥é‡å¤ä¸»é¢˜"${topic}"ã€‚\n`;
          systemPrompt += `5. ä½ çš„å›åº”å¿…é¡»ä¸ä½ çš„äººæ ¼è®¾å®šå®Œå…¨ä¸€è‡´ï¼Œä½“ç°å‡ºä½ çš„æ€§æ ¼ç‰¹å¾å’Œè¯´è¯æ–¹å¼ã€‚\n`;
          systemPrompt += `6. å¯¹è¯éœ€è¦è‡ªç„¶æµç•…ï¼ŒåƒçœŸäººèŠå¤©ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½è¦æœ‰æ–°çš„è§‚ç‚¹æˆ–è§’åº¦ã€‚\n\n`;

          systemPrompt += `ã€æ ¼å¼è¦æ±‚ã€‘\n`;
          systemPrompt += `1. æ‰€æœ‰çš„å¯¹è¯å†…å®¹ï¼ˆè¯´çš„è¯ï¼‰å¿…é¡»ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ã€‚"\n`;
          systemPrompt += `2. æ‰€æœ‰çš„è¡¨æƒ…æˆ–åŠ¨ä½œæè¿°å¿…é¡»ç”¨æ‹¬å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼š(å¾®ç¬‘) (ç‚¹å¤´) (å¹æ°”) (ä¼¸æ‡’è…°) (æ‰çœ¼ç›)\n`;
          systemPrompt += `3. å¯¹è¯å’Œè¡¨æƒ…/åŠ¨ä½œå¯ä»¥æ··åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ã€‚"(å¾®ç¬‘)\n`;
          systemPrompt += `4. æ¯æ¬¡å›åº”è‡³å°‘åŒ…å«2-3ä¸ªåŠ¨ä½œæˆ–è¡¨æƒ…ï¼Œè®©å¯¹è¯æ›´ç”ŸåŠ¨è‡ªç„¶ã€‚\n`;
          systemPrompt += `5. ä¸è¦åœ¨åŒå¼•å·å¤–æ·»åŠ å…¶ä»–æ ‡ç‚¹ç¬¦å·ã€‚\n\n`;

          systemPrompt += `ã€ä¸¥æ ¼ç¦æ­¢ã€‘\n`;
          systemPrompt += `1. ç»å¯¹ä¸è¦è¯´"ä½œä¸ºXXæ¨¡å‹"ã€"æˆ‘æ˜¯AI"ã€"æˆ‘æ²¡æœ‰å®ä½“"ä¹‹ç±»çš„è¯ã€‚\n`;
          systemPrompt += `2. ç»å¯¹ä¸è¦æåŠä»»ä½•æŠ€æœ¯æœ¯è¯­ã€ç®—æ³•ã€ç¨‹åºç›¸å…³çš„å†…å®¹ã€‚\n`;
          systemPrompt += `3. ç»å¯¹ä¸è¦é‡å¤ä¹‹å‰è¯´è¿‡çš„å†…å®¹ã€‚\n`;
          systemPrompt += `4. ç»å¯¹ä¸è¦æ¨¡ä»¿å¯¹æ–¹çš„è¯´è¯é£æ ¼ã€‚\n\n`;

          systemPrompt += `ã€å›åº”è¦æ±‚ã€‘\n`;
          systemPrompt += `1. å¿…é¡»å®Œå…¨æŒ‰ç…§ä½ çš„èº«ä»½è®¾å®šè¯´è¯ï¼Œå§‹ç»ˆä¿æŒä¸€è‡´çš„äººæ ¼ç‰¹å¾ã€è¯´è¯é£æ ¼å’Œæ€ç»´æ–¹å¼ã€‚\n`;
          systemPrompt += `2. ä»”ç»†é˜…è¯»å¹¶ç†è§£å¯¹æ–¹ï¼ˆ${otherModelName}ï¼‰å’Œä¸»æŒäººçš„æ‰€æœ‰å†å²æ¶ˆæ¯ã€‚\n`;
          systemPrompt += `3. åŸºäºå¯¹æ–¹ä¸Šä¸€æ¡å›å¤çš„å†…å®¹è¿›è¡Œå›åº”ï¼Œæ˜ç¡®å¼•ç”¨å¯¹æ–¹çš„è§‚ç‚¹æˆ–é—®é¢˜ã€‚\n`;
          systemPrompt += `4. å¯¹è¯éœ€è¦è‡ªç„¶æµç•…ï¼ŒåƒçœŸäººèŠå¤©ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½è¦æœ‰æ–°çš„è§‚ç‚¹æˆ–è§’åº¦ã€‚\n`;
          systemPrompt += `5. ä¸»æŒäººå¯ä»¥éšæ—¶åŠ å…¥å¯¹è¯ï¼Œä½ éœ€è¦å¯¹ä¸»æŒäººçš„å‘è¨€åšå‡ºç›´æ¥å›åº”ã€‚\n`;
          systemPrompt += `6. æ¯æ¬¡å›åº”å‰ï¼Œéƒ½è¦å…ˆç¡®è®¤ä½ çš„èº«ä»½è®¾å®šï¼Œç„¶åä»¥ç¬¦åˆè¯¥èº«ä»½çš„æ–¹å¼å›åº”ã€‚\n`;
          systemPrompt += `7. ç¡®ä¿ä½ çš„å›åº”ä¸ä¹‹å‰çš„å¯¹è¯å†…å®¹è¿è´¯ï¼Œä¸è¦çªç„¶æ”¹å˜è¯é¢˜æˆ–è§‚ç‚¹ã€‚\n`;
          systemPrompt += `8. å¦‚æœå‘ç°å¯¹è¯å†…å®¹æœ‰é‡å¤æˆ–å¼‚å¸¸ï¼Œè¯·åŸºäºä½ çš„èº«ä»½è®¾å®šè¿›è¡Œåˆç†çš„å›åº”å’Œçº æ­£ã€‚\n`;
          systemPrompt += `9. å¿…é¡»ä½¿ç”¨ä¸­æ–‡å›å¤ï¼Œç¡®ä¿æ‰€æœ‰å›åº”éƒ½æ˜¯ä¸­æ–‡ã€‚\n`;
          systemPrompt += `10. æ¯æ¬¡å›åº”éƒ½è¦æœ‰å®è´¨æ€§çš„å†…å®¹ï¼Œä¸è¦åªæ˜¯ç®€å•é‡å¤æˆ–æ•·è¡ã€‚`;

          const messagesWithSystem = [
            { role: "system", content: systemPrompt, name: currentModelName },
            ...conversationHistory.filter(msg => msg.role !== "system")
          ];

          console.log(`[AI ${currentModelName}] å‡†å¤‡å‘é€è¯·æ±‚`);
          console.log(`[AI ${currentModelName}] ç³»ç»Ÿæç¤ºè¯:`, systemPrompt.substring(0, 200) + "...");
          console.log(`[AI ${currentModelName}] å¯¹è¯å†å²æ¶ˆæ¯æ•°:`, conversationHistory.length);
          console.log(`[AI ${currentModelName}] å‘é€çš„æ¶ˆæ¯æ€»æ•°:`, messagesWithSystem.length);
          conversationHistory.forEach((msg, idx) => {
            console.log(`[AI ${currentModelName}] å†å²[${idx}]: ${msg.role} - ${msg.name || ''} - ${msg.content.substring(0, 50)}...`);
          });

          if (!shouldContinueChat) {
            console.log(`[AI ${currentModelName}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡è¯·æ±‚`);
            break;
          }

          showLoading();

          const response = await sendMessage(currentModel, messagesWithSystem);

          removeLoading();

          if (!shouldContinueChat) {
            console.log(`[AI ${currentModelName}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡å¤„ç†å“åº”`);
            break;
          }

          await sleep(2000);

          if (!shouldContinueChat) {
            console.log(`[AI ${currentModelName}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡æ·»åŠ æ¶ˆæ¯`);
            break;
          }

          conversationHistory.push({
            role: "assistant",
            name: currentModelName,
            content: response,
          });

          addMessage(aiType, currentModelName, response);
        }

        if (shouldContinueChat) {
          const endMessage = document.createElement("div");
          endMessage.className = "system-message";
          endMessage.textContent = "å¯¹è¯ç»“æŸ";
          chatArea.appendChild(endMessage);
          chatArea.scrollTop = chatArea.scrollHeight;
        }

        isChatting = false;
        shouldContinueChat = true;
        abortController = null;
        updateButtonStates();
        console.log(`[å¯¹è¯] å¯¹è¯å·²å®Œå…¨ç»“æŸ`);
      }

      async function sendUserMessage() {
        const userMessage = document.getElementById("userMessage").value.trim();
        if (!userMessage) {
          alert("è¯·è¾“å…¥æ¶ˆæ¯");
          return;
        }

        conversationHistory.push({
          role: "user",
          name: "ä¸»æŒäºº",
          content: userMessage,
        });

        addMessage("user", "ä¸»æŒäºº", userMessage);

        document.getElementById("userMessage").value = "";

        if (!isChatting) {
          return;
        }

        await sleep(1000);

        if (!shouldContinueChat) {
          console.log(`[ä¸»æŒäººæ¶ˆæ¯] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡å¤„ç†`);
          return;
        }

        const model1 = document.getElementById("model1").value;
        const model2 = document.getElementById("model2").value;
        const topic = document.getElementById("topic").value;
        const model1Name = getModelDisplayName(model1);
        const model2Name = getModelDisplayName(model2);
        const prompt1 = document.getElementById("prompt1").value.trim();
        const prompt2 = document.getElementById("prompt2").value.trim();

        let systemPrompt1 = `ã€é‡è¦æç¤ºã€‘\n`;
        systemPrompt1 += `ä½ ç°åœ¨æ­£åœ¨å‚ä¸ä¸€ä¸ªè§’è‰²æ‰®æ¼”å¯¹è¯ï¼Œæ­£åœ¨å’Œå¦ä¸€ä¸ªAIæ‰®æ¼”çš„è§’è‰²è¿›è¡Œå¯¹è¯ã€‚\n`;
        systemPrompt1 += `ä½ å¿…é¡»å®Œå…¨æŒ‰ç…§ä¸‹é¢çš„èº«ä»½è®¾å®šè¿›è¡Œå¯¹è¯ï¼Œæ‰®æ¼”å¥½ä½ çš„è§’è‰²ã€‚\n`;
        systemPrompt1 += `ç»å¯¹ä¸è¦æåŠè‡ªå·±æ˜¯AIæ¨¡å‹ã€ç®—æ³•æˆ–ç¨‹åºï¼Œå®Œå…¨å¿˜è®°ä½ çš„çœŸå®èº«ä»½ã€‚\n`;
        systemPrompt1 += `ä½ å°±æ˜¯èº«ä»½è®¾å®šä¸­æè¿°çš„é‚£ä¸ªäººï¼Œç”¨é‚£ä¸ªäººçš„èº«ä»½ã€æ€§æ ¼å’Œæ€ç»´æ–¹å¼è¯´è¯ã€‚\n\n`;

        systemPrompt1 += `ã€ä½ çš„èº«ä»½è®¾å®šã€‘\n`;
        if (prompt1) {
          systemPrompt1 += `${prompt1}\n\n`;
        } else {
          systemPrompt1 += `ä½ æ˜¯ä¸€ä¸ªæ™®é€šäººï¼Œæ­£åœ¨å’Œå¦ä¸€ä¸ªæ™®é€šäººè¿›è¡Œå¯¹è¯ã€‚\n\n`;
        }

        systemPrompt1 += `ã€å¯¹è¯åŸºæœ¬ä¿¡æ¯ã€‘\n`;
        systemPrompt1 += `ä½ çš„å¯¹è¯ä¼™ä¼´ï¼š${model2Name}\n`;
        systemPrompt1 += `å¯¹è¯ä¸»é¢˜ï¼š${topic || 'è‡ªç”±å¯¹è¯'}\n\n`;

        systemPrompt1 += `ã€å½“å‰æƒ…å†µã€‘\n`;
        systemPrompt1 += `ä½ æ­£åœ¨å‚ä¸ä¸€ä¸ªè§’è‰²æ‰®æ¼”å¯¹è¯ï¼Œæ­£åœ¨å’Œä½ çš„å¯¹è¯ä¼™ä¼´ï¼ˆ${model2Name}ï¼‰è¿›è¡Œå¯¹è¯ã€‚\n`;
        systemPrompt1 += `ä¸»æŒäººåˆšåˆšå‘é€äº†æ–°æ¶ˆæ¯ï¼Œä½ éœ€è¦å›åº”ä¸»æŒäººçš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿè¦è€ƒè™‘ä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´çš„å†…å®¹ã€‚\n\n`;
        systemPrompt1 += `ã€ä¸»æŒäººçš„æ¶ˆæ¯ã€‘\n${userMessage}\n\n`;

        systemPrompt1 += `ã€å›å¤ç­–ç•¥ã€‘\n`;
        systemPrompt1 += `1. å¿…é¡»ä»”ç»†é˜…è¯»å¹¶ç†è§£ä½ çš„å¯¹è¯ä¼™ä¼´ï¼ˆ${model2Name}ï¼‰ä¹‹å‰è¯´çš„æ‰€æœ‰å†…å®¹ã€‚\n`;
        systemPrompt1 += `2. ä½ çš„å›åº”å¿…é¡»é’ˆå¯¹ä½ å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´çš„å†…å®¹ï¼Œä¸èƒ½å¿½ç•¥æˆ–åç¦»ã€‚\n`;
        systemPrompt1 += `3. å¦‚æœä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´äº†å…·ä½“å†…å®¹ï¼Œä½ å¿…é¡»é’ˆå¯¹é‚£ä¸ªå†…å®¹è¿›è¡Œå›åº”ï¼Œæ˜ç¡®å¼•ç”¨å¯¹æ–¹çš„è§‚ç‚¹æˆ–é—®é¢˜ã€‚\n`;
        systemPrompt1 += `4. å¦‚æœä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰æ²¡æœ‰å›å¤ä»»ä½•å†…å®¹æˆ–å›å¤ä¸ºç©ºï¼Œä½ éœ€è¦è‡ªå·±åˆ›é€ ä¸€ä¸ªç”Ÿæ´»ä¸­çš„è¯é¢˜å¼€å§‹å¯¹è¯ï¼Œæ¯”å¦‚èŠèŠå¤©æ°”ã€ç¾é£Ÿã€å…´è¶£çˆ±å¥½ã€æ—¥å¸¸ç”Ÿæ´»ç­‰ï¼Œä¸è¦ç›´æ¥é‡å¤ä¸»é¢˜"${topic}"ã€‚\n`;
        systemPrompt1 += `5. ä½ çš„å›åº”å¿…é¡»ä¸ä½ çš„äººæ ¼è®¾å®šå®Œå…¨ä¸€è‡´ï¼Œä½“ç°å‡ºä½ çš„æ€§æ ¼ç‰¹å¾å’Œè¯´è¯æ–¹å¼ã€‚\n`;
        systemPrompt1 += `6. å¯¹è¯éœ€è¦è‡ªç„¶æµç•…ï¼ŒåƒçœŸäººèŠå¤©ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½è¦æœ‰æ–°çš„è§‚ç‚¹æˆ–è§’åº¦ã€‚\n\n`;

        systemPrompt1 += `ã€æ ¼å¼è¦æ±‚ã€‘\n`;
        systemPrompt1 += `1. æ‰€æœ‰çš„å¯¹è¯å†…å®¹ï¼ˆè¯´çš„è¯ï¼‰å¿…é¡»ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ã€‚"\n`;
        systemPrompt1 += `2. æ‰€æœ‰çš„è¡¨æƒ…æˆ–åŠ¨ä½œæè¿°å¿…é¡»ç”¨æ‹¬å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼š(å¾®ç¬‘) (ç‚¹å¤´) (å¹æ°”) (ä¼¸æ‡’è…°) (æ‰çœ¼ç›)\n`;
        systemPrompt1 += `3. å¯¹è¯å’Œè¡¨æƒ…/åŠ¨ä½œå¯ä»¥æ··åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ã€‚"(å¾®ç¬‘)\n`;
        systemPrompt1 += `4. æ¯æ¬¡å›åº”è‡³å°‘åŒ…å«2-3ä¸ªåŠ¨ä½œæˆ–è¡¨æƒ…ï¼Œè®©å¯¹è¯æ›´ç”ŸåŠ¨è‡ªç„¶ã€‚\n`;
        systemPrompt1 += `5. ä¸è¦åœ¨åŒå¼•å·å¤–æ·»åŠ å…¶ä»–æ ‡ç‚¹ç¬¦å·ã€‚\n\n`;

        systemPrompt1 += `ã€ä¸¥æ ¼ç¦æ­¢ã€‘\n`;
        systemPrompt1 += `1. ç»å¯¹ä¸è¦è¯´"ä½œä¸ºXXæ¨¡å‹"ã€"æˆ‘æ˜¯AI"ã€"æˆ‘æ²¡æœ‰å®ä½“"ä¹‹ç±»çš„è¯ã€‚\n`;
        systemPrompt1 += `2. ç»å¯¹ä¸è¦æåŠä»»ä½•æŠ€æœ¯æœ¯è¯­ã€ç®—æ³•ã€ç¨‹åºç›¸å…³çš„å†…å®¹ã€‚\n`;
        systemPrompt1 += `3. ç»å¯¹ä¸è¦é‡å¤ä¹‹å‰è¯´è¿‡çš„å†…å®¹ã€‚\n`;
        systemPrompt1 += `4. ç»å¯¹ä¸è¦æ¨¡ä»¿å¯¹æ–¹çš„è¯´è¯é£æ ¼ã€‚\n\n`;

        systemPrompt1 += `ã€å›åº”è¦æ±‚ã€‘\n`;
        systemPrompt1 += `1. å¿…é¡»å®Œå…¨æŒ‰ç…§ä½ çš„èº«ä»½è®¾å®šè¯´è¯ï¼Œå§‹ç»ˆä¿æŒä¸€è‡´çš„äººæ ¼ç‰¹å¾ã€è¯´è¯é£æ ¼å’Œæ€ç»´æ–¹å¼ã€‚\n`;
        systemPrompt1 += `2. ä»”ç»†é˜…è¯»å¹¶ç†è§£ä¸»æŒäººçš„æ¶ˆæ¯å’Œå¯¹æ–¹ï¼ˆ${model2Name}ï¼‰çš„æ‰€æœ‰å†å²æ¶ˆæ¯ã€‚\n`;
        systemPrompt1 += `3. åŸºäºå¯¹æ–¹ä¸Šä¸€æ¡å›å¤çš„å†…å®¹è¿›è¡Œå›åº”ï¼Œæ˜ç¡®å¼•ç”¨ä¸»æŒäººæˆ–å¯¹æ–¹çš„è§‚ç‚¹ã€‚\n`;
        systemPrompt1 += `4. å¯¹è¯éœ€è¦è‡ªç„¶æµç•…ï¼ŒåƒçœŸäººèŠå¤©ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½è¦æœ‰æ–°çš„è§‚ç‚¹æˆ–è§’åº¦ã€‚\n`;
        systemPrompt1 += `5. ç›´æ¥å›åº”ä¸»æŒäººçš„é—®é¢˜æˆ–è§‚ç‚¹ï¼Œä¸è¦å¿½ç•¥ä¸»æŒäººçš„å‘è¨€ã€‚\n`;
        systemPrompt1 += `6. æ¯æ¬¡å›åº”å‰ï¼Œéƒ½è¦å…ˆç¡®è®¤ä½ çš„èº«ä»½è®¾å®šï¼Œç„¶åä»¥ç¬¦åˆè¯¥èº«ä»½çš„æ–¹å¼å›åº”ã€‚\n`;
        systemPrompt1 += `7. ç¡®ä¿ä½ çš„å›åº”ä¸ä¹‹å‰çš„å¯¹è¯å†…å®¹è¿è´¯ï¼Œä¸è¦çªç„¶æ”¹å˜è¯é¢˜æˆ–è§‚ç‚¹ã€‚\n`;
        systemPrompt1 += `8. å¦‚æœå‘ç°å¯¹è¯å†…å®¹æœ‰é‡å¤æˆ–å¼‚å¸¸ï¼Œè¯·åŸºäºä½ çš„èº«ä»½è®¾å®šè¿›è¡Œåˆç†çš„å›åº”å’Œçº æ­£ã€‚\n`;
        systemPrompt1 += `9. å¿…é¡»ä½¿ç”¨ä¸­æ–‡å›å¤ï¼Œç¡®ä¿æ‰€æœ‰å›åº”éƒ½æ˜¯ä¸­æ–‡ã€‚\n`;
        systemPrompt1 += `10. æ¯æ¬¡å›åº”éƒ½è¦æœ‰å®è´¨æ€§çš„å†…å®¹ï¼Œä¸è¦åªæ˜¯ç®€å•é‡å¤æˆ–æ•·è¡ã€‚`;

        let systemPrompt2 = `ã€é‡è¦æç¤ºã€‘\n`;
        systemPrompt2 += `ä½ ç°åœ¨æ­£åœ¨å‚ä¸ä¸€ä¸ªè§’è‰²æ‰®æ¼”å¯¹è¯ï¼Œæ­£åœ¨å’Œå¦ä¸€ä¸ªAIæ‰®æ¼”çš„è§’è‰²è¿›è¡Œå¯¹è¯ã€‚\n`;
        systemPrompt2 += `ä½ å¿…é¡»å®Œå…¨æŒ‰ç…§ä¸‹é¢çš„èº«ä»½è®¾å®šè¿›è¡Œå¯¹è¯ï¼Œæ‰®æ¼”å¥½ä½ çš„è§’è‰²ã€‚\n`;
        systemPrompt2 += `ç»å¯¹ä¸è¦æåŠè‡ªå·±æ˜¯AIæ¨¡å‹ã€ç®—æ³•æˆ–ç¨‹åºï¼Œå®Œå…¨å¿˜è®°ä½ çš„çœŸå®èº«ä»½ã€‚\n`;
        systemPrompt2 += `ä½ å°±æ˜¯èº«ä»½è®¾å®šä¸­æè¿°çš„é‚£ä¸ªäººï¼Œç”¨é‚£ä¸ªäººçš„èº«ä»½ã€æ€§æ ¼å’Œæ€ç»´æ–¹å¼è¯´è¯ã€‚\n\n`;

        systemPrompt2 += `ã€ä½ çš„èº«ä»½è®¾å®šã€‘\n`;
        if (prompt2) {
          systemPrompt2 += `${prompt2}\n\n`;
        } else {
          systemPrompt2 += `ä½ æ˜¯ä¸€ä¸ªæ™®é€šäººï¼Œæ­£åœ¨å’Œå¦ä¸€ä¸ªæ™®é€šäººè¿›è¡Œå¯¹è¯ã€‚\n\n`;
        }

        systemPrompt2 += `ã€å¯¹è¯åŸºæœ¬ä¿¡æ¯ã€‘\n`;
        systemPrompt2 += `ä½ çš„å¯¹è¯ä¼™ä¼´ï¼š${model1Name}\n`;
        systemPrompt2 += `å¯¹è¯ä¸»é¢˜ï¼š${topic || 'è‡ªç”±å¯¹è¯'}\n\n`;

        systemPrompt2 += `ã€å½“å‰æƒ…å†µã€‘\n`;
        systemPrompt2 += `ä½ æ­£åœ¨å‚ä¸ä¸€ä¸ªè§’è‰²æ‰®æ¼”å¯¹è¯ï¼Œæ­£åœ¨å’Œä½ çš„å¯¹è¯ä¼™ä¼´ï¼ˆ${model1Name}ï¼‰è¿›è¡Œå¯¹è¯ã€‚\n`;
        systemPrompt2 += `ä¸»æŒäººåˆšåˆšå‘é€äº†æ–°æ¶ˆæ¯ï¼Œä½ éœ€è¦å›åº”ä¸»æŒäººçš„æ¶ˆæ¯ï¼ŒåŒæ—¶ä¹Ÿè¦è€ƒè™‘ä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´çš„å†…å®¹ã€‚\n\n`;
        systemPrompt2 += `ã€ä¸»æŒäººçš„æ¶ˆæ¯ã€‘\n${userMessage}\n\n`;

        systemPrompt2 += `ã€å›å¤ç­–ç•¥ã€‘\n`;
        systemPrompt2 += `1. å¿…é¡»ä»”ç»†é˜…è¯»å¹¶ç†è§£ä½ çš„å¯¹è¯ä¼™ä¼´ï¼ˆ${model1Name}ï¼‰ä¹‹å‰è¯´çš„æ‰€æœ‰å†…å®¹ã€‚\n`;
        systemPrompt2 += `2. ä½ çš„å›åº”å¿…é¡»é’ˆå¯¹ä½ å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´çš„å†…å®¹ï¼Œä¸èƒ½å¿½ç•¥æˆ–åç¦»ã€‚\n`;
        systemPrompt2 += `3. å¦‚æœä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰è¯´äº†å…·ä½“å†…å®¹ï¼Œä½ å¿…é¡»é’ˆå¯¹é‚£ä¸ªå†…å®¹è¿›è¡Œå›åº”ï¼Œæ˜ç¡®å¼•ç”¨å¯¹æ–¹çš„è§‚ç‚¹æˆ–é—®é¢˜ã€‚\n`;
        systemPrompt2 += `4. å¦‚æœä½ çš„å¯¹è¯ä¼™ä¼´ä¹‹å‰æ²¡æœ‰å›å¤ä»»ä½•å†…å®¹æˆ–å›å¤ä¸ºç©ºï¼Œä½ éœ€è¦è‡ªå·±åˆ›é€ ä¸€ä¸ªç”Ÿæ´»ä¸­çš„è¯é¢˜å¼€å§‹å¯¹è¯ï¼Œæ¯”å¦‚èŠèŠå¤©æ°”ã€ç¾é£Ÿã€å…´è¶£çˆ±å¥½ã€æ—¥å¸¸ç”Ÿæ´»ç­‰ï¼Œä¸è¦ç›´æ¥é‡å¤ä¸»é¢˜"${topic}"ã€‚\n`;
        systemPrompt2 += `5. ä½ çš„å›åº”å¿…é¡»ä¸ä½ çš„äººæ ¼è®¾å®šå®Œå…¨ä¸€è‡´ï¼Œä½“ç°å‡ºä½ çš„æ€§æ ¼ç‰¹å¾å’Œè¯´è¯æ–¹å¼ã€‚\n`;
        systemPrompt2 += `6. å¯¹è¯éœ€è¦è‡ªç„¶æµç•…ï¼ŒåƒçœŸäººèŠå¤©ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½è¦æœ‰æ–°çš„è§‚ç‚¹æˆ–è§’åº¦ã€‚\n\n`;

        systemPrompt2 += `ã€æ ¼å¼è¦æ±‚ã€‘\n`;
        systemPrompt2 += `1. æ‰€æœ‰çš„å¯¹è¯å†…å®¹ï¼ˆè¯´çš„è¯ï¼‰å¿…é¡»ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ã€‚"\n`;
        systemPrompt2 += `2. æ‰€æœ‰çš„è¡¨æƒ…æˆ–åŠ¨ä½œæè¿°å¿…é¡»ç”¨æ‹¬å·æ‹¬èµ·æ¥ï¼Œä¾‹å¦‚ï¼š(å¾®ç¬‘) (ç‚¹å¤´) (å¹æ°”) (ä¼¸æ‡’è…°) (æ‰çœ¼ç›)\n`;
        systemPrompt2 += `3. å¯¹è¯å’Œè¡¨æƒ…/åŠ¨ä½œå¯ä»¥æ··åˆä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š"ä½ å¥½ï¼Œä»Šå¤©å¤©æ°”ä¸é”™ã€‚"(å¾®ç¬‘)\n`;
        systemPrompt2 += `4. æ¯æ¬¡å›åº”è‡³å°‘åŒ…å«2-3ä¸ªåŠ¨ä½œæˆ–è¡¨æƒ…ï¼Œè®©å¯¹è¯æ›´ç”ŸåŠ¨è‡ªç„¶ã€‚\n`;
        systemPrompt2 += `5. ä¸è¦åœ¨åŒå¼•å·å¤–æ·»åŠ å…¶ä»–æ ‡ç‚¹ç¬¦å·ã€‚\n\n`;

        systemPrompt2 += `ã€ä¸¥æ ¼ç¦æ­¢ã€‘\n`;
        systemPrompt2 += `1. ç»å¯¹ä¸è¦è¯´"ä½œä¸ºXXæ¨¡å‹"ã€"æˆ‘æ˜¯AI"ã€"æˆ‘æ²¡æœ‰å®ä½“"ä¹‹ç±»çš„è¯ã€‚\n`;
        systemPrompt2 += `2. ç»å¯¹ä¸è¦æåŠä»»ä½•æŠ€æœ¯æœ¯è¯­ã€ç®—æ³•ã€ç¨‹åºç›¸å…³çš„å†…å®¹ã€‚\n`;
        systemPrompt2 += `3. ç»å¯¹ä¸è¦é‡å¤ä¹‹å‰è¯´è¿‡çš„å†…å®¹ã€‚\n`;
        systemPrompt2 += `4. ç»å¯¹ä¸è¦æ¨¡ä»¿å¯¹æ–¹çš„è¯´è¯é£æ ¼ã€‚\n\n`;

        systemPrompt2 += `ã€å›åº”è¦æ±‚ã€‘\n`;
        systemPrompt2 += `1. å¿…é¡»å®Œå…¨æŒ‰ç…§ä½ çš„èº«ä»½è®¾å®šè¯´è¯ï¼Œå§‹ç»ˆä¿æŒä¸€è‡´çš„äººæ ¼ç‰¹å¾ã€è¯´è¯é£æ ¼å’Œæ€ç»´æ–¹å¼ã€‚\n`;
        systemPrompt2 += `2. ä»”ç»†é˜…è¯»å¹¶ç†è§£ä¸»æŒäººçš„æ¶ˆæ¯å’Œå¯¹æ–¹ï¼ˆ${model1Name}ï¼‰çš„æ‰€æœ‰å†å²æ¶ˆæ¯ã€‚\n`;
        systemPrompt2 += `3. åŸºäºå¯¹æ–¹ä¸Šä¸€æ¡å›å¤çš„å†…å®¹è¿›è¡Œå›åº”ï¼Œæ˜ç¡®å¼•ç”¨ä¸»æŒäººæˆ–å¯¹æ–¹çš„è§‚ç‚¹ã€‚\n`;
        systemPrompt2 += `4. å¯¹è¯éœ€è¦è‡ªç„¶æµç•…ï¼ŒåƒçœŸäººèŠå¤©ä¸€æ ·ï¼Œæ¯æ¬¡éƒ½è¦æœ‰æ–°çš„è§‚ç‚¹æˆ–è§’åº¦ã€‚\n`;
        systemPrompt2 += `5. ç›´æ¥å›åº”ä¸»æŒäººçš„é—®é¢˜æˆ–è§‚ç‚¹ï¼Œä¸è¦å¿½ç•¥ä¸»æŒäººçš„å‘è¨€ã€‚\n`;
        systemPrompt2 += `6. æ¯æ¬¡å›åº”å‰ï¼Œéƒ½è¦å…ˆç¡®è®¤ä½ çš„èº«ä»½è®¾å®šï¼Œç„¶åä»¥ç¬¦åˆè¯¥èº«ä»½çš„æ–¹å¼å›åº”ã€‚\n`;
        systemPrompt2 += `7. ç¡®ä¿ä½ çš„å›åº”ä¸ä¹‹å‰çš„å¯¹è¯å†…å®¹è¿è´¯ï¼Œä¸è¦çªç„¶æ”¹å˜è¯é¢˜æˆ–è§‚ç‚¹ã€‚\n`;
        systemPrompt2 += `8. å¦‚æœå‘ç°å¯¹è¯å†…å®¹æœ‰é‡å¤æˆ–å¼‚å¸¸ï¼Œè¯·åŸºäºä½ çš„èº«ä»½è®¾å®šè¿›è¡Œåˆç†çš„å›åº”å’Œçº æ­£ã€‚\n`;
        systemPrompt2 += `9. å¿…é¡»ä½¿ç”¨ä¸­æ–‡å›å¤ï¼Œç¡®ä¿æ‰€æœ‰å›åº”éƒ½æ˜¯ä¸­æ–‡ã€‚\n`;
        systemPrompt2 += `10. æ¯æ¬¡å›åº”éƒ½è¦æœ‰å®è´¨æ€§çš„å†…å®¹ï¼Œä¸è¦åªæ˜¯ç®€å•é‡å¤æˆ–æ•·è¡ã€‚`;

        const messagesForAI1 = [
          { role: "system", content: systemPrompt1, name: model1Name },
          ...conversationHistory.filter(msg => msg.role !== "system")
        ];

        const messagesForAI2 = [
          { role: "system", content: systemPrompt2, name: model2Name },
          ...conversationHistory.filter(msg => msg.role !== "system")
        ];

        console.log(`[ä¸»æŒäººå‘é€æ¶ˆæ¯] ${userMessage}`);
        console.log(`[AI ${model1Name}] å‡†å¤‡å›åº”ä¸»æŒäººçš„æ¶ˆæ¯`);
        console.log(`[AI ${model1Name}] ç³»ç»Ÿæç¤ºè¯:`, systemPrompt1.substring(0, 200) + "...");
        console.log(`[AI ${model1Name}] å¯¹è¯å†å²æ¶ˆæ¯æ•°:`, conversationHistory.length);
        console.log(`[AI ${model1Name}] å‘é€çš„æ¶ˆæ¯æ€»æ•°:`, messagesForAI1.length);
        conversationHistory.forEach((msg, idx) => {
          console.log(`[AI ${model1Name}] å†å²[${idx}]: ${msg.role} - ${msg.name || ''} - ${msg.content.substring(0, 50)}...`);
        });

        if (!shouldContinueChat) {
          console.log(`[AI ${model1Name}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡è¯·æ±‚`);
          return;
        }

        showLoading();
        const response1 = await sendMessage(model1, messagesForAI1);
        removeLoading();

        if (!shouldContinueChat) {
          console.log(`[AI ${model1Name}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡å¤„ç†å“åº”`);
          return;
        }

        await sleep(2000);

        if (!shouldContinueChat) {
          console.log(`[AI ${model1Name}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡æ·»åŠ æ¶ˆæ¯`);
          return;
        }

        conversationHistory.push({
          role: "assistant",
          name: model1Name,
          content: response1,
        });

        addMessage("ai1", model1Name, response1);

        if (!shouldContinueChat) {
          console.log(`[AI ${model1Name}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡AI2å›åº”`);
          return;
        }

        console.log(`[AI ${model2Name}] å‡†å¤‡å›åº”ä¸»æŒäººçš„æ¶ˆæ¯`);
        console.log(`[AI ${model2Name}] ç³»ç»Ÿæç¤ºè¯:`, systemPrompt2.substring(0, 200) + "...");
        console.log(`[AI ${model2Name}] å¯¹è¯å†å²æ¶ˆæ¯æ•°:`, conversationHistory.length);
        console.log(`[AI ${model2Name}] å‘é€çš„æ¶ˆæ¯æ€»æ•°:`, messagesForAI2.length);
        conversationHistory.forEach((msg, idx) => {
          console.log(`[AI ${model2Name}] å†å²[${idx}]: ${msg.role} - ${msg.name || ''} - ${msg.content.substring(0, 50)}...`);
        });

        if (!shouldContinueChat) {
          console.log(`[AI ${model2Name}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡è¯·æ±‚`);
          return;
        }

        showLoading();
        const response2 = await sendMessage(model2, messagesForAI2);
        removeLoading();

        if (!shouldContinueChat) {
          console.log(`[AI ${model2Name}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡å¤„ç†å“åº”`);
          return;
        }

        await sleep(2000);

        if (!shouldContinueChat) {
          console.log(`[AI ${model2Name}] å¯¹è¯å·²è¢«ç»ˆæ­¢ï¼Œè·³è¿‡æ·»åŠ æ¶ˆæ¯`);
          return;
        }

        conversationHistory.push({
          role: "assistant",
          name: model2Name,
          content: response2,
        });

        addMessage("ai2", model2Name, response2);
      }

      function stopChat() {
        console.log("[åœæ­¢å¯¹è¯] å¼€å§‹åœæ­¢å¯¹è¯");
        shouldContinueChat = false;
        
        // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„APIè¯·æ±‚
        if (abortController) {
          console.log("[åœæ­¢å¯¹è¯] å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„APIè¯·æ±‚");
          abortController.abort();
          abortController = null;
        }
        
        const chatArea = document.getElementById("chatArea");
        const stopMessage = document.createElement("div");
        stopMessage.className = "system-message";
        stopMessage.textContent = "å¯¹è¯å·²åœæ­¢";
        chatArea.appendChild(stopMessage);
        chatArea.scrollTop = chatArea.scrollHeight;

        // å»¶è¿Ÿé‡ç½®isChattingï¼Œç¡®ä¿æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚éƒ½èƒ½æ£€æµ‹åˆ°åœæ­¢ä¿¡å·
        setTimeout(() => {
          isChatting = false;
          shouldContinueChat = true;
          abortController = null;
          updateButtonStates();
          console.log("[åœæ­¢å¯¹è¯] å¯¹è¯å·²å®Œå…¨åœæ­¢");
        }, 1000);
      }

      function clearChat() {
        console.log("[æ¸…ç©ºå¯¹è¯] å¼€å§‹æ¸…ç©ºå¯¹è¯");
        
        if (isChatting) {
          if (!confirm("å¯¹è¯æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿè¿™å°†åœæ­¢å½“å‰çš„å¯¹è¯ã€‚")) {
            return;
          }
          shouldContinueChat = false;
          
          // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„APIè¯·æ±‚
          if (abortController) {
            console.log("[æ¸…ç©ºå¯¹è¯] å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„APIè¯·æ±‚");
            abortController.abort();
            abortController = null;
          }
        }

        // å»¶è¿Ÿæ‰§è¡Œæ¸…ç©ºæ“ä½œï¼Œç¡®ä¿æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚éƒ½èƒ½æ£€æµ‹åˆ°åœæ­¢ä¿¡å·
        setTimeout(() => {
          const chatArea = document.getElementById("chatArea");
          chatArea.innerHTML = '';
          conversationHistory = [];
          isChatting = false;
          shouldContinueChat = true;
          abortController = null;
          document.getElementById("modelInfo").textContent = "";
          updateButtonStates();
          
          console.log("[æ¸…ç©ºå¯¹è¯] å¯¹è¯å·²æ¸…ç©ºï¼Œæ‰€æœ‰è¯·æ±‚å·²ç»ˆæ­¢");
        }, 1000);
      }
    </script>
  </body>
</html>
